<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArUco 4×4 Pattern Generator</title>
  <link rel="icon" href="https://mess.engineering/favicon/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="https://mess.engineering/favicon/apple-touch-icon.png">
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #1a1a20;
      --border: #2a2a32;
      --accent: #00d4aa;
      --text: #e8e8ec;
      --muted: #888;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "Fira Code", "Consolas", monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
    }
    h1 { font-size: clamp(1.1rem, 3vw, 1.4rem); color: var(--accent); margin: 0 0 0.5rem 0; }
    .sub { font-size: 0.85rem; color: var(--muted); margin-bottom: 0.35rem; }
    .nav-links { font-size: 0.9rem; margin-bottom: 1rem; }
    .nav-links a { color: var(--accent); text-decoration: none; }
    .nav-links a:hover { text-decoration: underline; }
    .nav-sep { color: var(--muted); margin: 0 0.4rem; }
    section { margin-bottom: 1.5rem; }
    section h2 { font-size: 0.95rem; color: var(--muted); margin: 0 0 0.5rem 0; }
    .grid-wrap {
      display: inline-block;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      background: var(--surface);
    }
    .grid-row { display: flex; }
    .grid-cell {
      width: 22px; height: 22px;
      margin: 1px;
      border-radius: 4px;
      background: var(--border);
      cursor: pointer;
      transition: background 0.15s;
    }
    .grid-cell.real { background: var(--accent); }
    .grid-cell:hover { filter: brightness(1.2); }
    .controls { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin-bottom: 1rem; }
    button {
      font-family: inherit;
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
    }
    button:hover { background: #25252c; border-color: var(--accent); }
    button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    button.primary:hover { filter: brightness(1.1); }
    label { font-size: 0.85rem; color: var(--muted); }
    input[type="number"] { width: 4rem; margin-left: 0.25rem; padding: 0.35rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
    #outCanvas { display: block; max-width: 100%; height: auto; border: 1px solid var(--border); border-radius: 8px; background: #fff; }
    .preview-wrap { margin-top: 1rem; }
    .footer-by { margin-top: 2rem; font-size: 0.8rem; color: var(--muted); }
    .footer-by a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <h1>ArUco 4×4 Pattern Generator</h1>
  <p class="sub">Build a custom matrix, then generate and download a PNG. Same codes as DICT_4X4_250 (browser-only).</p>
  <nav class="nav-links">
    <a href="scanner.html">← Scanner</a>
    <span class="nav-sep">·</span>
    <a href="generator.html">Pattern generator</a>
  </nav>

  <section>
    <h2>Layout: click cells — filled = real marker (ID 0–249), empty = fake (ID 250+)</h2>
    <div class="controls">
      <button type="button" id="btnSmiley" class="primary">Smiley preset</button>
      <button type="button" id="btnClear">Clear</button>
    </div>
    <div class="grid-wrap" id="gridWrap"></div>
  </section>

  <section>
    <h2>Options</h2>
    <div class="controls">
      <label>Marker size (px): <input type="number" id="markerPx" value="60" min="20" max="200"></label>
      <label>Quiet zone between markers (px): <input type="number" id="paddingPx" value="14" min="2" max="60"></label>
    </div>
  </section>

  <section>
    <h2>Generate &amp; Download</h2>
    <div class="controls">
      <button type="button" id="btnGenerate" class="primary">Generate PNG</button>
      <a id="btnDownload" href="#" download="aruco_pattern.png" style="display: none;">Download PNG</a>
    </div>
    <div class="preview-wrap">
      <canvas id="outCanvas"></canvas>
    </div>
  </section>

  <p class="footer-by">Brought to you by <a href="https://mess.engineering" target="_blank" rel="noopener">M.E.S.S.</a></p>

  <script>
    (function () {
      // DICT_4X4_250 (250 codes, same as OpenCV)
      var CODE_LIST_4X4_250 = [0x32b5,0x9a0f,0x2d33,0x4699,0x9e54,0xcd79,0x2e9e,0xf2c4,0xdafe,0x56cf,0x91f9,0xa711,0xb70e,0xf2a,0xb124,0x3e26,0x6546,0x66,0x5e6c,0xaf76,0x8b86,0x2bb0,0xd5cc,0x82dd,0x47fe,0x7194,0xe4ac,0x54a5,0x2321,0x6f34,0x1544,0xb257,0xcf9e,0xcbf0,0xae08,0x2909,0x7518,0xff04,0xf60d,0x5a1c,0x1817,0x282a,0x8c32,0xb238,0xe824,0xeb2e,0x3f2d,0x644b,0x2e50,0x1350,0x9451,0x6855,0x415d,0x975f,0x168,0x6768,0x2461,0xe961,0x126b,0xe56f,0xdf67,0x1b7e,0xa080,0x4483,0xa28b,0x7a93,0x6c84,0x2a85,0x9c85,0x899c,0xa19f,0x7cbb,0x4bc,0x5bb6,0xc8bf,0xabb7,0x1fca,0x62c9,0x58d9,0xd5d3,0x98cc,0xa0c7,0x37c5,0x5de9,0x25f9,0xbbfb,0x2aee,0x4df7,0x7535,0xad8a,0x1776,0xcf0a,0x4b06,0xc12d,0xd849,0xf443,0x364f,0xd34f,0xe469,0xc770,0x6e7a,0xeab4,0x4fed,0xe7fc,0xa6fe,0x2500,0x4300,0x880a,0x860a,0x6f02,0x1c00,0x9700,0x3708,0x310a,0xc609,0x10b,0xfb09,0x580b,0x8210,0x2d18,0x7810,0x7310,0x7412,0xb112,0xf91a,0x613,0xe0c,0xf10c,0x3304,0x9f0c,0xf20e,0xfd0e,0x4c07,0xa40f,0x2f07,0xb505,0x910f,0xdb07,0xe41e,0x3914,0x801d,0xc815,0x8b1f,0xba15,0xb11d,0x8020,0xe928,0xa222,0x5328,0xf02a,0xf722,0x4029,0x4621,0xb929,0x9c2b,0xb22b,0xca38,0x2e38,0x730,0xe738,0x493a,0x653a,0x5d32,0x883b,0x1d39,0xd33b,0x4726,0x8027,0xaa2f,0x142d,0xde25,0x5325,0x772f,0x4834,0xa83c,0x413c,0xd34,0xfb34,0x9a36,0xe03d,0x6a35,0x93d,0xed3d,0xc43f,0x6c3f,0xce37,0x5c3d,0x763d,0xb037,0x173f,0xff3f,0xe548,0x6842,0x2d4a,0x6041,0x5149,0xdd41,0xdf4b,0x4f58,0x485a,0x1658,0x5d50,0xfa5a,0xb55a,0x2351,0x8a5b,0x1959,0x3551,0x694c,0xc146,0xb4e,0x5f44,0x594e,0x834d,0x7d4d,0xd847,0x7347,0x855c,0x445e,0x2b56,0xbb5c,0xc355,0x6e5f,0xeb5f,0x125d,0x5e55,0x7062,0x1562,0xc261,0x206b,0x4563,0x5c6b,0x5b6b,0xc78,0xcf7a,0x7f78,0x8079,0xe571,0x7471,0xb679,0xd371,0x337b,0x6a64,0xa866,0xa76e,0x916e,0x2265,0xcb6d,0x8d67,0x316d];

      var ROWS = 11, COLS = 11;
      var SMILEY = [
        [0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,0,0,0,1,1,1,0],
        [0,1,0,1,0,0,0,1,0,1,0],
        [0,1,1,1,0,0,0,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,0,0,0,0,0,0,1],
        [0,1,0,0,0,0,0,0,0,1,0],
        [0,0,1,0,0,0,0,0,1,0,0],
        [0,0,0,1,1,1,1,1,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0]
      ];

      // 4x4 marker: black frame (1 module), white border (1 module), 4x4 data. Total 6x6 cells.
      function drawMarker(ctx, code, x, y, cellPx) {
        var size = 6 * cellPx;
        ctx.fillStyle = '#000';
        ctx.fillRect(x, y, size, size);
        ctx.fillStyle = '#fff';
        ctx.fillRect(x + cellPx, y + cellPx, 4 * cellPx, 4 * cellPx);
        ctx.fillStyle = '#000';
        for (var r = 0; r < 4; r++) {
          for (var c = 0; c < 4; c++) {
            var bit = (code >>> (r * 4 + c)) & 1;
            if (bit) ctx.fillRect(x + (c + 1) * cellPx, y + (r + 1) * cellPx, cellPx, cellPx);
          }
        }
      }

      var grid = [];
      for (var r = 0; r < ROWS; r++) {
        grid[r] = [];
        for (var c = 0; c < COLS; c++) grid[r][c] = 0;
      }

      function renderGrid() {
        var wrap = document.getElementById('gridWrap');
        wrap.innerHTML = '';
        for (var r = 0; r < ROWS; r++) {
          var rowEl = document.createElement('div');
          rowEl.className = 'grid-row';
          for (var c = 0; c < COLS; c++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell' + (grid[r][c] ? ' real' : '');
            cell.dataset.r = r;
            cell.dataset.c = c;
            cell.addEventListener('click', function () {
              var r = parseInt(this.dataset.r, 10), c = parseInt(this.dataset.c, 10);
              grid[r][c] = grid[r][c] ? 0 : 1;
              renderGrid();
            });
            rowEl.appendChild(cell);
          }
          wrap.appendChild(rowEl);
        }
      }

      function applyPreset(matrix) {
        for (var r = 0; r < ROWS && r < matrix.length; r++)
          for (var c = 0; c < COLS && c < matrix[r].length; c++)
            grid[r][c] = matrix[r][c];
        renderGrid();
      }

      document.getElementById('btnSmiley').addEventListener('click', function () { applyPreset(SMILEY); });
      document.getElementById('btnClear').addEventListener('click', function () {
        for (var r = 0; r < ROWS; r++) for (var c = 0; c < COLS; c++) grid[r][c] = 0;
        renderGrid();
      });

      function generate() {
        var markerPx = Math.max(20, Math.min(200, parseInt(document.getElementById('markerPx').value, 10) || 60));
        var padding = Math.max(2, Math.min(60, parseInt(document.getElementById('paddingPx').value, 10) || 14));
        var cellPx = Math.floor(markerPx / 6);
        var totalCell = 6 * cellPx;
        var w = COLS * totalCell + (COLS + 1) * padding;
        var h = ROWS * totalCell + (ROWS + 1) * padding;

        var canvas = document.getElementById('outCanvas');
        canvas.width = w;
        canvas.height = h;
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, w, h);

        var realIdx = 0, fakeIdx = 0;
        for (var r = 0; r < ROWS; r++) {
          for (var c = 0; c < COLS; c++) {
            var px = c * totalCell + (c + 1) * padding;
            var py = r * totalCell + (r + 1) * padding;
            var id, code;
            if (grid[r][c]) {
              id = realIdx % 250;
              realIdx++;
              code = CODE_LIST_4X4_250[id];
            } else {
              id = 250 + (fakeIdx % 250);
              fakeIdx++;
              code = CODE_LIST_4X4_250[id - 250];
            }
            drawMarker(ctx, code, px, py, cellPx);
          }
        }

        var link = document.getElementById('btnDownload');
        link.href = canvas.toDataURL('image/png');
        link.download = 'aruco_pattern.png';
        link.style.display = 'inline-block';
        link.style.color = 'var(--accent)';
        link.style.marginLeft = '0.5rem';
      }

      document.getElementById('btnGenerate').addEventListener('click', generate);
      renderGrid();
    })();
  </script>
</body>
</html>
