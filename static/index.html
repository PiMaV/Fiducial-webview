<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>ArUco 4×4 Web Scanner</title>
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #1a1a20;
      --border: #2a2a32;
      --accent: #00d4aa;
      --text: #e8e8ec;
      --muted: #888;
      --error: #e05555;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "Fira Code", "Consolas", monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    h1 {
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      font-weight: 600;
      color: var(--accent);
      margin: 0 0 0.5rem 0;
    }
    .sub {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }
    .viewport {
      position: relative;
      width: 100%;
      max-width: 720px;
      border-radius: 12px;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      aspect-ratio: 4/3;
    }
    #video {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }
    #overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      transform: scaleX(-1);
    }
    #canvas {
      display: none;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
      justify-content: center;
    }
    button {
      font-family: inherit;
      font-size: 0.9rem;
      padding: 0.6rem 1.2rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    button:hover { background: #25252c; border-color: var(--accent); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.primary {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    button.primary:hover:not(:disabled) { filter: brightness(1.1); }
    .status {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: var(--muted);
      min-height: 1.5em;
    }
    .status.error { color: var(--error); }
    .markers-list {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      max-width: 720px;
      width: 100%;
    }
    .markers-list h3 {
      margin: 0 0 0.5rem 0;
      font-size: 0.95rem;
      color: var(--accent);
    }
    .markers-list ul { margin: 0; padding-left: 1.2rem; }
    .markers-list li { margin: 0.2rem 0; }
  </style>
</head>
<body>
  <h1>ArUco 4×4 Web Scanner</h1>
  <p class="sub">Camera → frame → server (OpenCV ArUco) → overlay</p>

  <div class="viewport">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    <canvas id="canvas"></canvas>
  </div>

  <div class="controls">
    <button id="btnStart" class="primary">Start camera</button>
    <button id="btnStop" disabled>Stop camera</button>
    <label>
      <input type="checkbox" id="autoScan" checked> Auto-scan
    </label>
  </div>

  <p class="status" id="status">Start the camera to scan for 4×4 ArUco markers.</p>
  <div class="markers-list" id="markersList" style="display: none;">
    <h3>Detected markers (4×4)</h3>
    <ul id="markersUl"></ul>
  </div>

  <script>
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const canvas = document.getElementById("canvas");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const autoScan = document.getElementById("autoScan");
    const statusEl = document.getElementById("status");
    const markersList = document.getElementById("markersList");
    const markersUl = document.getElementById("markersUl");

    let stream = null;
    let scanInterval = null;
    const API_BASE = "";

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.classList.toggle("error", isError);
    }

    function drawOverlay(markers) {
      const w = overlay.width;
      const h = overlay.height;
      const ctx = overlay.getContext("2d");
      ctx.clearRect(0, 0, w, h);
      if (!markers || markers.length === 0) return;

      // Capture is mirrored; overlay has scaleX(-1). Mirror corners so they align with video.
      ctx.save();
      ctx.scale(-1, 1);
      ctx.translate(-w, 0);
      ctx.strokeStyle = "#00d4aa";
      ctx.lineWidth = 3;
      ctx.font = "16px monospace";
      ctx.fillStyle = "#00d4aa";

      for (const m of markers) {
        const corners = m.corners;
        if (corners.length < 4) continue;
        ctx.beginPath();
        ctx.moveTo(corners[0][0], corners[0][1]);
        for (let i = 1; i < corners.length; i++) {
          ctx.lineTo(corners[i][0], corners[i][1]);
        }
        ctx.closePath();
        ctx.stroke();
        const cx = (corners[0][0] + corners[2][0]) / 2;
        const cy = (corners[0][1] + corners[2][1]) / 2;
        ctx.fillText("ID " + m.id, cx - 20, cy);
      }
      ctx.restore();
    }

    function updateMarkersList(markers) {
      if (!markers || markers.length === 0) {
        markersList.style.display = "none";
        return;
      }
      markersList.style.display = "block";
      markersUl.innerHTML = markers.map((m) => `<li>Marker ID: ${m.id}</li>`).join("");
    }

    async function captureAndDetect() {
      if (video.readyState < 2 || !stream) return;
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (w === 0 || h === 0) return;

      canvas.width = w;
      canvas.height = h;
      overlay.width = w;
      overlay.height = h;
      const ctx = canvas.getContext("2d");
      ctx.save();
      ctx.scale(-1, 1);
      ctx.drawImage(video, -w, 0, w, h);
      ctx.restore();

      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", 0.85));
      if (!blob) return;

      try {
        const res = await fetch(API_BASE + "/api/detect", {
          method: "POST",
          body: blob,
          headers: { "Content-Type": "image/jpeg" },
        });
        const data = await res.json();
        if (data.ok) {
          drawOverlay(data.markers);
          updateMarkersList(data.markers);
          if (data.markers.length > 0) {
            setStatus(`Found ${data.markers.length} marker(s).`);
          }
        } else {
          setStatus(data.error || "Detection failed", true);
        }
      } catch (e) {
        setStatus("Network error: " + e.message, true);
      }
    }

    function startAutoScan() {
      stopAutoScan();
      scanInterval = setInterval(captureAndDetect, 250);
    }

    function stopAutoScan() {
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
    }

    async function startCamera() {
      try {
        setStatus("Requesting camera…");
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false,
        });
        video.srcObject = stream;
        btnStart.disabled = true;
        btnStop.disabled = false;
        setStatus("Camera on. Scanning for 4×4 ArUco markers…");
        if (autoScan.checked) startAutoScan();
      } catch (e) {
        setStatus("Camera error: " + e.message, true);
      }
    }

    function stopCamera() {
      stopAutoScan();
      if (stream) {
        stream.getTracks().forEach((t) => t.stop());
        stream = null;
      }
      video.srcObject = null;
      btnStart.disabled = false;
      btnStop.disabled = true;
      drawOverlay([]);
      updateMarkersList([]);
      setStatus("Camera off. Start again to scan.");
    }

    btnStart.addEventListener("click", startCamera);
    btnStop.addEventListener("click", stopCamera);
    autoScan.addEventListener("change", () => {
      if (stream && autoScan.checked) startAutoScan();
      else stopAutoScan();
    });
  </script>
</body>
</html>
