<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>ArUco &amp; AprilTag Web Scanner</title>
  <link rel="icon" href="https://mess.engineering/favicon/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="https://mess.engineering/favicon/apple-touch-icon.png">
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #1a1a20;
      --border: #2a2a32;
      --accent: #00d4aa;
      --text: #e8e8ec;
      --muted: #888;
      --error: #e05555;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "Fira Code", "Consolas", monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    h1 { font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 600; color: var(--accent); margin: 0 0 0.5rem 0; }
    .sub { font-size: 0.85rem; color: var(--muted); margin-bottom: 0.35rem; }
    .nav-links { font-size: 0.9rem; margin-bottom: 1rem; }
    .nav-links a { color: var(--accent); text-decoration: none; }
    .nav-links a:hover { text-decoration: underline; }
    .nav-sep { color: var(--muted); margin: 0 0.4rem; }
    @media (max-width: 640px) {
      body { padding: 0.5rem 0.5rem 1rem; }
      h1 { font-size: 1rem; margin-bottom: 0.25rem; }
      .sub { font-size: 0.75rem; margin-bottom: 0.5rem; line-height: 1.2; }
      .controls { margin-top: 0.5rem; margin-bottom: 0.5rem; }
    }
    .live-row { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; width: 100%; max-width: 960px; }
    .viewport, .viewport-debug {
      position: relative;
      flex: 1 1 0;
      min-width: 260px;
      max-width: 460px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      aspect-ratio: 4/3;
    }
    .viewport-debug {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .viewport-debug canvas { width: 100%; height: 100%; object-fit: contain; display: block; }
    #video { display: block; width: 100%; height: 100%; object-fit: contain; }
    #overlay {
      position: absolute; inset: 0; pointer-events: none;
      width: 100%; height: 100%; object-fit: contain;
    }
    #canvas { display: none; }
    .controls { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem; justify-content: center; }
    button {
      font-family: inherit;
      font-size: 0.9rem;
      padding: 0.6rem 1.2rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    button:hover { background: #25252c; border-color: var(--accent); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    button.primary:hover:not(:disabled) { filter: brightness(1.1); }
    .status { margin-top: 1rem; font-size: 0.85rem; color: var(--muted); min-height: 1.5em; text-align: center; max-width: 720px; }
    .status.error { color: var(--error); }
    .secure-warning {
      background: var(--surface);
      border: 1px solid var(--error);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      max-width: 720px;
      color: var(--text);
      font-size: 0.9rem;
    }
    .secure-warning strong { color: var(--error); }
    .markers-line { margin-top: 0.5rem; font-size: 0.85rem; color: var(--muted); min-height: 1.2em; }
    .markers-line .ids { color: var(--accent); }
    .footer-by { margin-top: auto; padding: 1rem 0.5rem 0.75rem; font-size: 0.8rem; color: var(--muted); text-align: center; }
    .footer-by a { color: var(--accent); text-decoration: none; }
    .footer-by a:hover { text-decoration: underline; }
    .debug-label { position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%); text-align: center; color: var(--muted); font-size: 0.85rem; pointer-events: none; }
    @media (max-width: 640px) {
      .controls label, .controls button { min-height: 44px; }
    }
  </style>
</head>
<body>
  <h1>ArUco &amp; AprilTag Web Scanner</h1>
  <p class="sub">Runs in the browser — no server. ArUco 4×4 (50/250/1000) or AprilTag 36h11 (WASM).</p>
  <nav class="nav-links">
    <a href="scanner.html">Scanner</a>
    <span class="nav-sep">·</span>
    <a href="generator.html">Pattern generator</a>
  </nav>

  <div id="secureWarning" class="secure-warning" style="display: none;">
    <strong>Camera not available</strong><br>
    <code>getUserMedia</code> only works in a <strong>secure context</strong>: HTTPS or <code>localhost</code>.
    Open this page via <code>https://fiducials.mess.engineering</code> or <code>http://localhost</code> — not <code>file://</code> or plain HTTP.
  </div>

  <div class="controls">
    <button id="btnStart" class="primary">Start camera</button>
    <button id="btnStop" disabled>Stop camera</button>
    <label>Detector: <select id="detectorMode"><option value="apriltag" selected>AprilTag 36h11</option><option value="aruco">ArUco 4×4</option></select></label>
    <label title="Enable if IDs are wrong - compensates mirrored webcam.">
      <input type="checkbox" id="mirrorForDetection"> Mirror image
    </label>
    <span id="arucoOpts">
      <label>Dictionary: <select id="dictSize"><option value="50" selected>4×4 (50)</option><option value="250">4×4 (250)</option><option value="1000">4×4 (1000)</option></select></label>
      <label>ID convention: <select id="dictConvention"><option value="0">Normal</option><option value="1" selected>Byte swap (OpenCV)</option><option value="2">Bit reverse</option><option value="3">Byte + bit</option></select></label>
    </span>
    <label>Scanner input: <select id="debugMode"><option value="gray">Gray</option><option value="binary" selected>Binary</option></select></label>
  </div>

  <div class="live-row">
    <div class="viewport">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
      <canvas id="canvas"></canvas>
    </div>
    <div class="viewport-debug">
      <canvas id="debugView"></canvas>
      <p class="debug-label" id="debugLabel">Scanner input (start camera)</p>
    </div>
  </div>
  <p class="status" style="font-size:0.8rem; color:var(--muted); margin-top:0.5rem;">
    Left: camera + cyan boxes (ID). Right: what the scanner sees (gray / binary).
  </p>

  <p class="status" id="status">Load over HTTPS or localhost, then start the camera. You can switch ArUco ↔ AprilTag while the camera is on. If it gets slow after long use, refresh the page.</p>
  <p class="markers-line" id="markersLine" aria-live="polite"></p>

  <p class="footer-by"><a href="https://mess.engineering" target="_blank" rel="noopener" title="Mattern Engineering &amp; Software Solutions">M.E.S.S.</a></p>

  <script src="https://cdn.jsdelivr.net/gh/damianofalcioni/js-aruco2@master/src/cv.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/damianofalcioni/js-aruco2@master/src/aruco.js"></script>
  <script>
    (function () {
      // CI colors (M.E.S.S. – mess.engineering)
      var CI_LIVE = { r: 0, g: 255, b: 255 };   // Cyan – live camera overlay
      var CI_CUBOID = { r: 255, g: 0, b: 255 }; // Magenta – binary/gray 3D boxes

      // Built-in 4×4 dictionary (OpenCV DICT_4X4_250, 250 codes)
      var CODE_LIST_4X4_250 = [0x32b5,0x9a0f,0x2d33,0x4699,0x9e54,0xcd79,0x2e9e,0xf2c4,0xdafe,0x56cf,0x91f9,0xa711,0xb70e,0xf2a,0xb124,0x3e26,0x6546,0x66,0x5e6c,0xaf76,0x8b86,0x2bb0,0xd5cc,0x82dd,0x47fe,0x7194,0xe4ac,0x54a5,0x2321,0x6f34,0x1544,0xb257,0xcf9e,0xcbf0,0xae08,0x2909,0x7518,0xff04,0xf60d,0x5a1c,0x1817,0x282a,0x8c32,0xb238,0xe824,0xeb2e,0x3f2d,0x644b,0x2e50,0x1350,0x9451,0x6855,0x415d,0x975f,0x168,0x6768,0x2461,0xe961,0x126b,0xe56f,0xdf67,0x1b7e,0xa080,0x4483,0xa28b,0x7a93,0x6c84,0x2a85,0x9c85,0x899c,0xa19f,0x7cbb,0x4bc,0x5bb6,0xc8bf,0xabb7,0x1fca,0x62c9,0x58d9,0xd5d3,0x98cc,0xa0c7,0x37c5,0x5de9,0x25f9,0xbbfb,0x2aee,0x4df7,0x7535,0xad8a,0x1776,0xcf0a,0x4b06,0xc12d,0xd849,0xf443,0x364f,0xd34f,0xe469,0xc770,0x6e7a,0xeab4,0x4fed,0xe7fc,0xa6fe,0x2500,0x4300,0x880a,0x860a,0x6f02,0x1c00,0x9700,0x3708,0x310a,0xc609,0x10b,0xfb09,0x580b,0x8210,0x2d18,0x7810,0x7310,0x7412,0xb112,0xf91a,0x613,0xe0c,0xf10c,0x3304,0x9f0c,0xf20e,0xfd0e,0x4c07,0xa40f,0x2f07,0xb505,0x910f,0xdb07,0xe41e,0x3914,0x801d,0xc815,0x8b1f,0xba15,0xb11d,0x8020,0xe928,0xa222,0x5328,0xf02a,0xf722,0x4029,0x4621,0xb929,0x9c2b,0xb22b,0xca38,0x2e38,0x730,0xe738,0x493a,0x653a,0x5d32,0x883b,0x1d39,0xd33b,0x4726,0x8027,0xaa2f,0x142d,0xde25,0x5325,0x772f,0x4834,0xa83c,0x413c,0xd34,0xfb34,0x9a36,0xe03d,0x6a35,0x93d,0xed3d,0xc43f,0x6c3f,0xce37,0x5c3d,0x763d,0xb037,0x173f,0xff3f,0xe548,0x6842,0x2d4a,0x6041,0x5149,0xdd41,0xdf4b,0x4f58,0x485a,0x1658,0x5d50,0xfa5a,0xb55a,0x2351,0x8a5b,0x1959,0x3551,0x694c,0xc146,0xb4e,0x5f44,0x594e,0x834d,0x7d4d,0xd847,0x7347,0x855c,0x445e,0x2b56,0xbb5c,0xc355,0x6e5f,0xeb5f,0x125d,0x5e55,0x7062,0x1562,0xc261,0x206b,0x4563,0x5c6b,0x5b6b,0xc78,0xcf7a,0x7f78,0x8079,0xe571,0x7471,0xb679,0xd371,0x337b,0x6a64,0xa866,0xa76e,0x916e,0x2265,0xcb6d,0x8d67,0x316d];
      var CODE_LIST_4X4_1000 = [0x32b5,0x9a0f,0x2d33,0x4699,0x9e54,0xcd79,0x2e9e,0xf2c4,0xdafe,0x56cf,0x91f9,0xa711,0xb70e,0xf2a,0xb124,0x3e26,0x6546,0x66,0x5e6c,0xaf76,0x8b86,0x2bb0,0xd5cc,0x82dd,0x47fe,0x7194,0xe4ac,0x54a5,0x2321,0x6f34,0x1544,0xb257,0xcf9e,0xcbf0,0xae08,0x2909,0x7518,0xff04,0xf60d,0x5a1c,0x1817,0x282a,0x8c32,0xb238,0xe824,0xeb2e,0x3f2d,0x644b,0x2e50,0x1350,0x9451,0x6855,0x415d,0x975f,0x168,0x6768,0x2461,0xe961,0x126b,0xe56f,0xdf67,0x1b7e,0xa080,0x4483,0xa28b,0x7a93,0x6c84,0x2a85,0x9c85,0x899c,0xa19f,0x7cbb,0x4bc,0x5bb6,0xc8bf,0xabb7,0x1fca,0x62c9,0x58d9,0xd5d3,0x98cc,0xa0c7,0x37c5,0x5de9,0x25f9,0xbbfb,0x2aee,0x4df7,0x7535,0xad8a,0x1776,0xcf0a,0x4b06,0xc12d,0xd849,0xf443,0x364f,0xd34f,0xe469,0xc770,0x6e7a,0xeab4,0x4fed,0xe7fc,0xa6fe,0x2500,0x4300,0x880a,0x860a,0x6f02,0x1c00,0x9700,0x3708,0x310a,0xc609,0x10b,0xfb09,0x580b,0x8210,0x2d18,0x7810,0x7310,0x7412,0xb112,0xf91a,0x613,0xe0c,0xf10c,0x3304,0x9f0c,0xf20e,0xfd0e,0x4c07,0xa40f,0x2f07,0xb505,0x910f,0xdb07,0xe41e,0x3914,0x801d,0xc815,0x8b1f,0xba15,0xb11d,0x8020,0xe928,0xa222,0x5328,0xf02a,0xf722,0x4029,0x4621,0xb929,0x9c2b,0xb22b,0xca38,0x2e38,0x730,0xe738,0x493a,0x653a,0x5d32,0x883b,0x1d39,0xd33b,0x4726,0x8027,0xaa2f,0x142d,0xde25,0x5325,0x772f,0x4834,0xa83c,0x413c,0xd34,0xfb34,0x9a36,0xe03d,0x6a35,0x93d,0xed3d,0xc43f,0x6c3f,0xce37,0x5c3d,0x763d,0xb037,0x173f,0xff3f,0xe548,0x6842,0x2d4a,0x6041,0x5149,0xdd41,0xdf4b,0x4f58,0x485a,0x1658,0x5d50,0xfa5a,0xb55a,0x2351,0x8a5b,0x1959,0x3551,0x694c,0xc146,0xb4e,0x5f44,0x594e,0x834d,0x7d4d,0xd847,0x7347,0x855c,0x445e,0x2b56,0xbb5c,0xc355,0x6e5f,0xeb5f,0x125d,0x5e55,0x7062,0x1562,0xc261,0x206b,0x4563,0x5c6b,0x5b6b,0xc78,0xcf7a,0x7f78,0x8079,0xe571,0x7471,0xb679,0xd371,0x337b,0x6a64,0xa866,0xa76e,0x916e,0x2265,0xcb6d,0x8d67,0x316d,0x807e,0xe27e,0x8d7e,0xd274,0x327c,0x357e,0xab75,0x577,0x2b7f,0xda7d,0x927f,0x7580,0xf380,0xa681,0xed89,0xfc81,0xa698,0x209a,0x4391,0xf999,0x9391,0xd49b,0x984,0x6b84,0xc486,0x648e,0x1a86,0x4e85,0xcb8d,0x6785,0xaf85,0xd785,0xb387,0xe19c,0xf29c,0x1794,0x95,0xa295,0x239d,0x629f,0x529d,0xda95,0xc5a0,0xcdaa,0xd8a2,0x57a2,0x3da9,0x57a9,0x52ab,0x36a3,0x59a3,0xf4b0,0x12b8,0xbfb0,0x9db2,0xedbb,0x72b9,0x96b9,0xc3a4,0xd2ac,0xb1ae,0x82a5,0x65af,0x7ba5,0xfaaf,0x64b4,0x62bc,0x81b4,0xa0b6,0xeebe,0xdbe,0xd9bc,0xf8be,0x28b5,0x9b7,0xd2b7,0xeac0,0x19c0,0xfdc0,0xd3c8,0x5aca,0x4dc1,0xb4c9,0x57c1,0x98c3,0x1dc3,0x80d8,0xefd8,0x2bda,0x1ed0,0x5d1,0xadd3,0xa7db,0xc9c4,0x78cc,0x45cd,0xbc5,0xcfcf,0xacdc,0x2d4,0x63dc,0x27d4,0xf5d4,0x78d6,0xb8de,0xe6dd,0x5dd5,0xbddd,0x1ddf,0xcae2,0x6bea,0xb4e0,0x38e2,0xd4e2,0x22e3,0xd8e1,0x3f0,0xccf2,0xf6f8,0x49f1,0xeaf3,0x9cf1,0xf5f9,0x3bf1,0x8dec,0xc9ee,0xfe6,0xf7e4,0x60e7,0xe8ef,0xb2ed,0x15e5,0xd1ef,0x86f4,0x1fc,0xc3f6,0x7cf4,0x93fc,0x42f5,0x98fd,0x3df5,0xbd02,0xe100,0xe202,0xae02,0x7808,0x7400,0x9e08,0xd108,0x7d08,0x320a,0xde0a,0x5102,0xa201,0x8003,0x830b,0x4b0b,0x270b,0xef0b,0xb609,0x5909,0x9309,0xf80b,0xd903,0xf103,0xc410,0xab18,0xa01a,0x41a,0x6c1a,0xae1a,0x8912,0x1710,0xf31a,0x4019,0x211,0x2b11,0xcf11,0x221b,0x2e13,0x1511,0xbb13,0x200c,0xc90c,0xdc0c,0x360c,0x1406,0x7206,0x610d,0xd05,0x8f0d,0xe00f,0x490f,0x8507,0x9005,0x330d,0x960f,0x760f,0x6014,0x8d1c,0xda14,0x731c,0x941e,0xba1e,0xd916,0x3d1e,0xfb16,0xe91d,0xfe1d,0x9f1f,0x8b28,0xaf20,0xe22,0xa922,0x8d2a,0xa32a,0xef2a,0x9028,0x3b28,0x582a,0x3322,0xa021,0x221,0xa521,0xc721,0x32b,0x6723,0x3029,0xd229,0x192b,0x9b2b,0x972b,0x2838,0xa538,0x863a,0x132,0x9f38,0xd232,0x993a,0xd53a,0xe839,0xc13b,0x4333,0xe73b,0x9a31,0x9033,0x9e3b,0xc424,0x4a2c,0xad2c,0xcf2c,0x672c,0xea26,0xe52e,0x702c,0x122e,0xd12e,0x392e,0x6425,0xe725,0xcc2f,0xbc2d,0x712d,0xd525,0x9b25,0x1027,0x7c2f,0xf227,0x3a27,0xb62f,0xd327,0xb32f,0x1f27,0x4b3c,0xc036,0xee36,0xe93e,0xb834,0x143c,0x523c,0x7234,0x7e34,0xbf34,0x713e,0x533e,0x8c3d,0xa235,0x2e35,0x2d35,0xac37,0x7035,0xfa37,0xf13f,0xdb3f,0xc448,0xe948,0xc24a,0x414a,0xeb42,0x1348,0xd84a,0xfd42,0x174a,0x6349,0x6e43,0x3a41,0xb149,0x3d41,0x924b,0x9b4b,0x3f43,0x2258,0xaa50,0x2758,0xc852,0x8452,0xa52,0xf5a,0x9858,0x5c58,0xdb50,0xf750,0xf45a,0xec51,0x4251,0xd51,0x35b,0xeb53,0x7651,0x7159,0x9351,0xf953,0xb35b,0x9753,0x4c4c,0x4b44,0x234c,0x8c46,0x274e,0x9046,0xd44e,0xce45,0xe545,0x2745,0xc14f,0x547,0x3445,0x7245,0xc85c,0xe5c,0xeb54,0x8956,0x4356,0xe75e,0x705c,0xb254,0x795e,0xf356,0xa35d,0xf25d,0x1d55,0x9d5d,0xfc57,0xd257,0x735f,0x2d68,0xc368,0x8768,0x4a6a,0x6962,0xb960,0xff68,0xdc6a,0xda6a,0x3e6a,0x516a,0x316a,0xd762,0xcc61,0x826b,0xe36b,0x3a69,0x9e61,0x9561,0x7561,0x5f69,0x3769,0xda63,0x270,0x6378,0x4f70,0xca72,0xad7a,0x7b70,0x147a,0xf97a,0xd37a,0xbb7a,0xe279,0x2971,0x677b,0xd071,0x3979,0x3073,0xb973,0x5373,0xff73,0x886c,0x964,0x436c,0x666,0x8366,0xb064,0xda64,0x9f6e,0xc867,0xee6f,0x3b6d,0xd26f,0x8074,0xab7c,0x687e,0x27e,0x9c7c,0x3674,0x117c,0xde7e,0xb67e,0xdb76,0xc47d,0x8a7d,0x6d75,0x8877,0x2077,0x4177,0x3875,0xbe75,0x9b7d,0x5777,0x2888,0xac80,0xd88,0x6788,0x4e82,0xa18a,0x2b82,0x1880,0xf988,0x9d80,0x9c8a,0x3182,0x758a,0x9782,0x981,0xeb81,0x781,0x288b,0xac8b,0x2e83,0xe583,0x5081,0x3289,0x7a8b,0x968b,0x7d83,0x8790,0xfc9a,0xf592,0xaa91,0x4193,0x2593,0xeb9b,0x3499,0xf791,0xda9b,0x5693,0x4284,0x818c,0x4f8c,0x4886,0xa686,0x38e,0xe386,0x6f86,0xaf8e,0x5e84,0x7784,0xfa86,0x1e8e,0x378e,0xa87,0x8a8f,0x268f,0x2187,0xd87,0x7285,0x3e87,0x439c,0x619e,0x5894,0xf894,0x329c,0x7694,0xb194,0xdd94,0x9b94,0xdb9c,0x9c9e,0xd29e,0x1996,0xb19e,0x6995,0x6d9f,0x2b97,0xb695,0xb995,0x3d9d,0x579d,0xeca8,0x25a8,0xaca2,0x2a2,0x66aa,0x8faa,0xe7aa,0x30a8,0x7aa8,0xf6a8,0x93a8,0x14a2,0x34aa,0x72a2,0xf2aa,0xf1a2,0x40a1,0xaa9,0x26a1,0xc5a9,0xcfa9,0x34a1,0x12a9,0xfaa1,0x98ab,0xf7a3,0x6b0,0x45b0,0x8db8,0x84b2,0xf0b8,0x55b8,0x76b2,0x91ba,0x71b2,0xc0b9,0x42b9,0x2ab9,0x8cb3,0xcab3,0x66bb,0xfb3,0xdab1,0x14bb,0xf6bb,0x13b3,0x68a4,0x2cac,0xa1ac,0xebac,0xc7ac,0x67a4,0xc0a6,0xe0ae,0x23a6,0xe8ad,0xcca5,0xeca7,0x7cad,0x1aa5,0x91a5,0x19ad,0x97a5,0x6db4,0xcbbe,0x3abc,0xf5bc,0xbdbe,0xf3be,0x25b5,0x8fb5,0x68b7,0xe4bf,0xfebd,0x9dbd,0xf5b5,0xf3b5,0xb0bf,0x5ab7,0x3ebf,0x39b7,0xd5bf,0x1db7,0x35bf,0x7fb7,0x1c8,0xa5c0,0x82c2,0xbdc8,0xfcc2,0x91ca,0x5bc2,0x44c9,0x2ac1,0xc0c3,0x7ac9,0xb9c1,0x75c9,0xf7c1,0xb1cb,0x6cd0,0x87d8,0xafd0,0xc4da,0xcd2,0x9da,0x30d0,0x94d8,0x3ad0,0xb6d0,0x75d0,0x76d2,0x5dda,0x35da,0x17d2,0x2d9,0xe8d3,0xe5d3,0x9ad1,0xf6d1,0x51d1,0x14db,0x3ed3,0xd3d3,0x60c4,0xa7cc,0x42c6,0x47c6,0xe7ce,0x5cc4,0x1dcc,0x35cc,0xbcc6,0xa8cd,0xcc5,0xe4c5,0xc2c5,0x2dcd,0x59cd,0x95cd,0x93c5,0x5fc7,0xc5d4,0x88de,0x24d6,0xecde,0xe2d6,0xc6de,0x23de,0xdcdc,0x1adc,0x11d4,0x54de,0x94d6,0x9dde,0x81dd,0xa5d5,0xacd7,0x66d7,0xa9df,0xdcd5,0x1fdd,0xf0df,0x48e2,0xe8e2,0x7e2,0x5de0,0xf5ea,0x26eb,0xedeb,0x52e1,0x7ee1,0xdbe9,0x6f8,0xeef0,0xa1f8,0xfa,0xc2fa,0x9bf0,0xf4fa,0x3cfa,0xfcf2,0xbdf2,0x93f2,0x60f1,0xecf9,0x46f1,0xe1f9,0x48f3,0xaef3,0xc1f3,0x8bf3,0xa7f3,0x73f1,0x97f1,0xf4f3,0x32fb,0x7e4,0x4de6,0x55ec,0xc0ed,0x85ed,0xa2ef,0x4ee7,0xd5e5,0x50ef,0x22f4,0x89f4,0x29f4,0x6af6,0xbfe,0x6ffe,0x95f4,0x35f4,0x1ff4,0xb0f6,0xe8f5,0xc5f5,0x23fd,0xc0ff,0xccf7,0xe9f7,0xbcf5,0xf6fd,0xd9f5,0x97fd,0x3ffd,0x9cff,0x5aff,0xfef7,0x11ff,0xbff7];
      var raw4x4_1000 = null;

      function reverseBits16(x) {
        var out = 0;
        for (var i = 0; i < 16; i++) { out = (out << 1) | (x & 1); x >>>= 1; }
        return out >>> 0;
      }

      function buildCodeList(size, convention) {
        var raw = raw4x4_1000;
        var fallback = raw ? null : (size >= 1000 ? CODE_LIST_4X4_1000 : CODE_LIST_4X4_250);
        var n = Math.min(size, raw ? raw.length : (fallback ? fallback.length : 250));
        var list = [];
        for (var i = 0; i < n; i++) {
          var code;
          if (raw) {
            var b0 = raw[i][0], b1 = raw[i][1];
            if (convention === 1 || convention === 3) code = (b1 | (b0 << 8)) >>> 0;
            else code = (b0 | (b1 << 8)) >>> 0;
            if (convention === 2 || convention === 3) code = reverseBits16(code);
          } else {
            code = fallback[i];
            if (convention === 1 || convention === 3) code = ((code & 0xff) << 8) | (code >>> 8);
            if (convention === 2 || convention === 3) code = reverseBits16(code);
          }
          list.push(code);
        }
        return list;
      }

      function applyDictionary() {
        if (typeof AR === 'undefined' || !AR.DICTIONARIES) return;
        var size = parseInt(document.getElementById('dictSize').value, 10) || 1000;
        var convention = parseInt(document.getElementById('dictConvention').value, 10) || 0;
        var codeList = buildCodeList(size, convention);
        AR.DICTIONARIES['DICT_4X4'] = { nBits: 16, tau: 3, codeList: codeList };
      }

      applyDictionary();

      var video = document.getElementById('video');
      var overlay = document.getElementById('overlay');
      var canvas = document.getElementById('canvas');
      var btnStart = document.getElementById('btnStart');
      var btnStop = document.getElementById('btnStop');
      var detectorMode = document.getElementById('detectorMode');
      var arucoOpts = document.getElementById('arucoOpts');
      var mirrorForDetection = document.getElementById('mirrorForDetection');
      var dictSize = document.getElementById('dictSize');
      var dictConvention = document.getElementById('dictConvention');
      var debugMode = document.getElementById('debugMode');
      var statusEl = document.getElementById('status');
      var markersLine = document.getElementById('markersLine');
      var secureWarning = document.getElementById('secureWarning');
      var lastMarkerIds = '';

      var stream = null;
      var detector = null;
      var animationId = null;
      var useAprilTag = function () { return detectorMode && detectorMode.value === 'apriltag'; };
      var aprilTagDetector = null;
      var aprilTagReady = null;

      function setAprilTagReady() {
        if (aprilTagReady) return aprilTagReady;
        var resolveReady;
        aprilTagReady = new Promise(function (resolve) { resolveReady = resolve; });
        var base = 'https://arenaxr.github.io/apriltag-js-standalone/';
        window.AprilTagWasmModule = { locateFile: function (path) { return base + path; } };
        var script = document.createElement('script');
        script.src = base + 'apriltag_wasm.js';
        script.onload = function () {
          var getPromise = function () {
            var w = window.AprilTagWasm;
            if (typeof w === 'function') return w(window.AprilTagWasmModule);
            if (w && typeof w.then === 'function') return w;
            return null;
          };
          var promise = getPromise();
          if (!promise) {
            setTimeout(function () {
              var p = getPromise();
              if (p) p.then(onModule).catch(onErr); else resolveReady(null);
            }, 100);
            return;
          }
          promise.then(onModule).catch(onErr);
          function onModule(Module) {
            try {
              var _init = Module.cwrap('atagjs_init', 'number', []);
              var _set_opts = Module.cwrap('atagjs_set_detector_options', 'number', ['number', 'number', 'number', 'number', 'number', 'number', 'number']);
              var _set_img = Module.cwrap('atagjs_set_img_buffer', 'number', ['number', 'number', 'number']);
              var _detect = Module.cwrap('atagjs_detect', 'number', []);
              _init();
              _set_opts(2.0, 0, 1, 1, 0, 0, 0);
              aprilTagDetector = {
                detect: function (grayscale, w, h) {
                  var buf = _set_img(w, h, w);
                  Module.HEAPU8.set(grayscale, buf);
                  var ptr = _detect();
                  var len = Module.getValue(ptr, 'i32');
                  if (len === 0) return [];
                  var strPtr = Module.getValue(ptr + 4, 'i32');
                  var view = new Uint8Array(Module.HEAP8.buffer, strPtr, len);
                  var str = '';
                  for (var i = 0; i < len; i++) str += String.fromCharCode(view[i]);
                  return JSON.parse(str);
                }
              };
              resolveReady(aprilTagDetector);
            } catch (e) {
              resolveReady(null);
            }
          }
          function onErr(err) {
            resolveReady(null);
          }
        };
        script.onerror = function () { resolveReady(null); };
        document.head.appendChild(script);
        return aprilTagReady;
      }

      function applyDetectorSwitch() {
        var isApril = useAprilTag();
        if (isApril) {
          if (aprilTagDetector) {
            detector = aprilTagDetector;
            if (stream) setStatus('Switched to AprilTag 36h11.');
          } else {
            setAprilTagReady().then(function (atDetector) {
              if (atDetector) {
                detector = aprilTagDetector;
                if (stream) setStatus('Switched to AprilTag 36h11.');
              } else if (stream) setStatus('AprilTag failed to load. Stop and start camera to retry.', true);
            });
          }
        } else if (typeof AR !== 'undefined') {
          applyDictionary();
          detector = new AR.Detector({ dictionaryName: 'DICT_4X4' });
          if (stream) setStatus('Switched to ArUco 4×4.');
        }
      }

      function updateDetectorModeUI() {
        if (arucoOpts) arucoOpts.style.display = useAprilTag() ? 'none' : '';
        if (stream && detector) applyDetectorSwitch();
      }

      function setStatus(msg, isError) {
        statusEl.textContent = msg || '';
        statusEl.classList.toggle('error', !!isError);
      }

      function hasCameraSupport() {
        return typeof navigator !== 'undefined' && navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function';
      }

      function drawOverlay(markers) {
        var w = overlay.width;
        var h = overlay.height;
        var ctx = overlay.getContext('2d');
        ctx.clearRect(0, 0, w, h);
        if (!markers || markers.length === 0) return;
        ctx.lineWidth = 3;
        ctx.font = 'bold 18px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for (var i = 0; i < markers.length; i++) {
          var c = markers[i].corners;
          if (!c || c.length < 4) continue;
          ctx.strokeStyle = 'rgb(' + CI_LIVE.r + ',' + CI_LIVE.g + ',' + CI_LIVE.b + ')';
          ctx.beginPath();
          ctx.moveTo(c[0].x, c[0].y);
          for (var j = 1; j < c.length; j++) ctx.lineTo(c[j].x, c[j].y);
          ctx.closePath();
          ctx.stroke();
          var cx = (c[0].x + c[1].x + c[2].x + c[3].x) / 4;
          var cy = (c[0].y + c[1].y + c[2].y + c[3].y) / 4;
          var label = String(Number(markers[i].id));
          var metrics = ctx.measureText(label);
          var pad = 4;
          ctx.fillStyle = 'rgba(0,0,0,0.75)';
          ctx.fillRect(cx - metrics.width / 2 - pad, cy - 10, metrics.width + pad * 2, 20);
          ctx.fillStyle = 'rgb(' + CI_LIVE.r + ',' + CI_LIVE.g + ',' + CI_LIVE.b + ')';
          ctx.fillText(label, cx, cy);
        }
      }

      function drawDebugView(imageData, mode, markers, fps) {
        var debugView = document.getElementById('debugView');
        var debugLabel = document.getElementById('debugLabel');
        if (!imageData || !debugView) return;
        var w = imageData.width;
        var h = imageData.height;
        var data = imageData.data;
        debugView.width = w;
        debugView.height = h;
        var ctx = debugView.getContext('2d');
        var out = ctx.createImageData(w, h);
        var outData = out.data;
        for (var i = 0; i < w * h; i++) {
          var r = data[i * 4];
          var g = data[i * 4 + 1];
          var b = data[i * 4 + 2];
          var gray = (r + g + b) / 3;
          if (mode === 'binary') {
            var v = Math.round((gray > 128 ? 200 : 35) * 0.66);
            outData[i * 4] = outData[i * 4 + 1] = outData[i * 4 + 2] = v;
          } else {
            outData[i * 4] = outData[i * 4 + 1] = outData[i * 4 + 2] = gray;
          }
          outData[i * 4 + 3] = 255;
        }
        if (mode === 'gray') {
          for (var y = 1; y < h - 1; y++) {
            for (var x = 1; x < w - 1; x++) {
              var i = (y * w + x) * 4;
              var g = outData[i];
              var gL = outData[((y) * w + (x - 1)) * 4];
              var gR = outData[((y) * w + (x + 1)) * 4];
              var gT = outData[((y - 1) * w + x) * 4];
              var gB = outData[((y + 1) * w + x) * 4];
              var mag = Math.min(80, Math.abs(gR - gL) + Math.abs(gB - gT));
              outData[i] = Math.min(255, outData[i] + mag * 0.6);
              outData[i + 1] = Math.min(255, outData[i + 1] + mag * 0.5);
              outData[i + 2] = Math.min(255, outData[i + 2] + mag * 0.4);
            }
          }
        }
        ctx.putImageData(out, 0, 0);
        debugLabel.style.display = 'none';
        if (markers && markers.length > 0) {
          drawPseudo3DBoxes(ctx, markers, w, h, mode);
        }
        if (typeof fps === 'number' && fps >= 0) {
          ctx.font = 'bold 18px sans-serif';
          ctx.textAlign = 'right';
          ctx.textBaseline = 'top';
          ctx.fillStyle = fps > 10 ? '#00cc66' : '#e05555';
          ctx.fillText(fps + ' FPS', w - 8, 8);
        }
      }

      function drawPseudo3DBoxes(ctx, markers, imgW, imgH, mode) {
        var r = CI_CUBOID.r, g = CI_CUBOID.g, b = CI_CUBOID.b;
        var dirX = 0.15, dirY = 0.15;
        var isBinary = mode === 'binary';
        ctx.lineWidth = isBinary ? 5 : 3;
        ctx.strokeStyle = 'rgba(' + r + ',' + g + ',' + b + ',1)';
        var fillFront = 'rgba(' + r + ',' + g + ',' + b + ',' + (isBinary ? 0.35 : 0.3) + ')';
        var fillSide = 'rgba(' + r + ',' + g + ',' + b + ',' + (isBinary ? 0.2 : 0.15) + ')';
        var fillBack = 'rgba(' + r + ',' + g + ',' + b + ',' + (isBinary ? 0.12 : 0.1) + ')';
        for (var i = 0; i < markers.length; i++) {
          var c = markers[i].corners;
          if (!c || c.length < 4) continue;
          var edgeLen = 0;
          for (var k = 0; k < 4; k++) {
            var n = (k + 1) % 4;
            edgeLen += Math.sqrt((c[n].x - c[k].x) * (c[n].x - c[k].x) + (c[n].y - c[k].y) * (c[n].y - c[k].y));
          }
          edgeLen /= 4;
          var depth = edgeLen;
          var shiftX = depth * dirX;
          var shiftY = depth * dirY;
          var back = [
            { x: c[0].x + shiftX, y: c[0].y + shiftY },
            { x: c[1].x + shiftX, y: c[1].y + shiftY },
            { x: c[2].x + shiftX, y: c[2].y + shiftY },
            { x: c[3].x + shiftX, y: c[3].y + shiftY }
          ];
          for (var j = 0; j < 4; j++) {
            var n = (j + 1) % 4;
            ctx.fillStyle = fillSide;
            ctx.beginPath();
            ctx.moveTo(c[j].x, c[j].y);
            ctx.lineTo(c[n].x, c[n].y);
            ctx.lineTo(back[n].x, back[n].y);
            ctx.lineTo(back[j].x, back[j].y);
            ctx.closePath();
            ctx.fill();
          }
          ctx.fillStyle = fillBack;
          ctx.beginPath();
          ctx.moveTo(back[0].x, back[0].y);
          for (var j = 1; j < 4; j++) ctx.lineTo(back[j].x, back[j].y);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = fillFront;
          ctx.beginPath();
          ctx.moveTo(c[0].x, c[0].y);
          for (var j = 1; j < 4; j++) ctx.lineTo(c[j].x, c[j].y);
          ctx.closePath();
          ctx.fill();
          ctx.strokeStyle = 'rgba(' + r + ',' + g + ',' + b + ',1)';
          ctx.beginPath();
          ctx.moveTo(back[0].x, back[0].y);
          for (var j = 1; j < 4; j++) ctx.lineTo(back[j].x, back[j].y);
          ctx.closePath();
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(c[0].x, c[0].y);
          for (var j = 1; j < 4; j++) ctx.lineTo(c[j].x, c[j].y);
          ctx.closePath();
          ctx.stroke();
          for (var j = 0; j < 4; j++) {
            ctx.beginPath();
            ctx.moveTo(c[j].x, c[j].y);
            ctx.lineTo(back[j].x, back[j].y);
            ctx.stroke();
          }
        }
      }

      function updateMarkersList(markers) {
        if (!markersLine) return;
        if (markers === null) {
          markersLine.innerHTML = '';
          lastMarkerIds = '';
          return;
        }
        var ids = (markers && markers.length) ? markers.map(function(m) { return m.id; }).sort(function(a,b){ return a - b; }).join(', ') : '';
        if (ids === lastMarkerIds) return;
        lastMarkerIds = ids;
        markersLine.innerHTML = ids ? 'Detected: <span class="ids">' + ids + '</span>' : '';
      }

      var tickSkip = 0;
      var aprilTagGrayBuffer = null;
      var aprilTagGrayPixels = 0;
      var lastFpsTime = 0;
      var currentFps = 0;
      function isSmallScreen() { return typeof window !== 'undefined' && window.matchMedia && window.matchMedia('(max-width: 768px)').matches; }

      function imageDataToGray(imageData, intoBuffer) {
        var d = imageData.data;
        var n = imageData.width * imageData.height;
        var out = intoBuffer && intoBuffer.length >= n ? intoBuffer : new Uint8Array(n);
        for (var i = 0, j = 0; i < d.length; i += 4, j++) out[j] = (d[i] + d[i + 1] + d[i + 2]) / 3;
        return out;
      }

      function tick() {
        animationId = requestAnimationFrame(tick);
        if (!stream || !detector || video.readyState < 2) return;
        var now = typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now();
        if (lastFpsTime > 0) currentFps = Math.round(1000 / (now - lastFpsTime));
        lastFpsTime = now;
        tickSkip++;
        if (isSmallScreen() && tickSkip % 2 !== 0) return;
        var w = video.videoWidth;
        var h = video.videoHeight;
        if (w === 0 || h === 0) return;
        canvas.width = w;
        canvas.height = h;
        overlay.width = w;
        overlay.height = h;
        var ctx = canvas.getContext('2d');
        if (mirrorForDetection && mirrorForDetection.checked) {
          ctx.save();
          ctx.scale(-1, 1);
          ctx.drawImage(video, -w, 0, w, h);
          ctx.restore();
        } else {
          ctx.drawImage(video, 0, 0, w, h);
        }
        var imageData = ctx.getImageData(0, 0, w, h);
        var markers;
        if (useAprilTag() && aprilTagDetector) {
          var n = w * h;
          if (!aprilTagGrayBuffer || aprilTagGrayPixels !== n) {
            aprilTagGrayBuffer = new Uint8Array(n);
            aprilTagGrayPixels = n;
          }
          imageDataToGray(imageData, aprilTagGrayBuffer);
          markers = aprilTagDetector.detect(aprilTagGrayBuffer, w, h);
        } else {
          markers = detector.detect(imageData);
        }
        var mirror = mirrorForDetection && mirrorForDetection.checked;
        video.style.transform = mirror ? 'scaleX(-1)' : '';
        drawOverlay(markers);
        drawDebugView(imageData, debugMode ? debugMode.value : 'gray', markers, currentFps);
        updateMarkersList(markers);
        if (markers && markers.length > 0) setStatus('Found ' + markers.length + ' marker(s).');
      }

      function startCamera() {
        if (!hasCameraSupport()) {
          secureWarning.style.display = 'block';
          setStatus('Camera API not available. Use HTTPS (e.g. fiducials.mess.engineering) or localhost.', true);
          return;
        }
        secureWarning.style.display = 'none';
        var isApril = useAprilTag();
        if (isApril) {
          setStatus('Loading AprilTag WASM…');
          setAprilTagReady().then(function (atDetector) {
            if (!atDetector) { setStatus('AprilTag failed to load. Try same origin (HTTPS) or check console.', true); return; }
            requestCamera();
          });
        } else {
          requestCamera();
        }
        function requestCamera() {
          setStatus('Requesting camera…');
          var wantSmall = typeof window !== 'undefined' && window.innerWidth <= 768;
          navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: 'environment',
              width: wantSmall ? { ideal: 640, max: 640 } : { ideal: 1280 },
              height: wantSmall ? { ideal: 480, max: 480 } : { ideal: 720 }
            },
            audio: false
          })
            .then(function (s) {
              stream = s;
              video.srcObject = stream;
              btnStart.disabled = true;
              btnStop.disabled = false;
              if (useAprilTag()) {
                detector = aprilTagDetector;
                setStatus('Camera on. Scanning AprilTag 36h11…');
                tick();
              } else if (typeof AR !== 'undefined') {
                applyDictionary();
                detector = new AR.Detector({ dictionaryName: 'DICT_4X4' });
                setStatus('Camera on. Scanning 4×4 ArUco…');
                tick();
              } else {
                setStatus('ArUco library not loaded.', true);
              }
            })
            .catch(function (err) {
              setStatus('Camera error: ' + (err.message || err.name), true);
            });
        }
      }

      function stopCamera() {
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        if (stream) {
          stream.getTracks().forEach(function(t) { t.stop(); });
          stream = null;
        }
        video.srcObject = null;
        detector = null;
        aprilTagGrayBuffer = null;
        aprilTagGrayPixels = 0;
        lastFpsTime = 0;
        currentFps = 0;
        btnStart.disabled = false;
        btnStop.disabled = true;
        drawOverlay([]);
        updateMarkersList(null);
        var dl = document.getElementById('debugLabel');
        if (dl) dl.style.display = '';
        var dv = document.getElementById('debugView');
        if (dv && dv.getContext) { var c = dv.getContext('2d'); c.clearRect(0, 0, dv.width, dv.height); }
        setStatus('Camera off. Start again to scan.');
      }

      if (!hasCameraSupport()) {
        secureWarning.style.display = 'block';
        setStatus('Camera requires HTTPS (e.g. fiducials.mess.engineering) or localhost.', true);
      }

      function refreshDetector() {
        applyDictionary();
        if (detector) detector = new AR.Detector({ dictionaryName: 'DICT_4X4' });
      }

      detectorMode.addEventListener('change', updateDetectorModeUI);
      updateDetectorModeUI();
      btnStart.addEventListener('click', startCamera);
      btnStop.addEventListener('click', stopCamera);
      dictSize.addEventListener('change', refreshDetector);
      dictConvention.addEventListener('change', refreshDetector);
    })();
  </script>
</body>
</html>
